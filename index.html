<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hangar 94</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://www.youtube-nocookie.com">
  <link rel="preconnect" href="https://img.youtube.com">
  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-white min-h-screen flex flex-col items-center py-10">
  <img src="img/hangar.png" alt="Hangar 94 Logo" class="w-auto h-40 mb-6" />
  <h1 class="text-4xl text-center font-bold mb-2">ğŸ§ Reproductor Musica Karaoke</h1>
  <p class="text-gray-400 mb-8">Gestiona tu lista de reproducciÃ³n personal</p>

  <!-- Formulario -->
  <div class="flex flex-col sm:flex-row gap-3 mb-8 w-full max-w-4xl px-4">
    <input id="youtubeLink" type="text" placeholder="ğŸ”— Pega el enlace de YouTube aquÃ­..."
      class="px-4 py-3 rounded-lg text-black flex-1 focus:ring-2 focus:ring-red-500 outline-none" />
    <button id="addBtn" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg transition font-semibold shadow-lg">
      â• Agregar
    </button>
    <button id="clearBtn" class="bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg transition font-semibold">
      ğŸ—‘ï¸ Limpiar
    </button>
  </div>

  <!-- Mensaje si no hay canciones -->
  <div id="emptyState" class="w-full max-w-4xl px-4 text-center py-12 hidden">
    <div class="text-6xl mb-4">ğŸµ</div>
    <p class="text-xl text-gray-400">No hay canciones en tu lista</p>
    <p class="text-gray-500 mt-2">Agrega tu primera canciÃ³n pegando un enlace de YouTube arriba</p>
  </div>

  <!-- Lista de canciones -->
  <div class="w-full max-w-4xl px-4">
    <div id="songListHeader" class="flex items-center justify-between mb-4 hidden">
      <div>
        <h2 class="text-2xl font-semibold">ğŸ“‹ Tu Lista <span id="songCount" class="text-purple-400"></span></h2>
        <p class="text-sm text-gray-400 mt-1">ğŸ”„ Arrastra las canciones para reordenar</p>
      </div>
      <button id="playAllBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition text-sm font-semibold">
        â–¶ï¸ Reproducir Todo
      </button>
    </div>
    <ul id="songList" class="grid sm:grid-cols-2 gap-4"></ul>
  </div>

  <!-- Modal para reproducir video -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 p-4">
    <div class="bg-gray-800 rounded-xl max-w-4xl w-full p-6 relative">
      <button id="closeModal" class="absolute top-4 right-4 text-white hover:text-red-500 text-3xl font-bold">
        Ã—
      </button>
      <div class="mb-4">
        <h3 class="text-2xl font-bold mb-2" id="modalTitle">Reproducir Video</h3>
        <p class="text-gray-400" id="modalUrl"></p>
      </div>

      <div class="aspect-video bg-black rounded-lg overflow-hidden mb-4">
        <!-- IMPORTANTE: dejamos que la API cree el iframe aquÃ­ -->
        <div id="modalPlayer" class="w-full h-full"></div>
      </div>

      <div class="flex flex-wrap gap-3 justify-between">
        <div class="flex gap-3">
          <button id="prevBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg font-semibold transition">â®ï¸ Anterior</button>
          <button id="nextBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg font-semibold transition">â­ï¸ Siguiente</button>
        </div>
        <div class="flex gap-3">
          <a id="openYouTube" href="#" target="_blank" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold transition">
            ğŸ¬ Abrir en YouTube
          </a>
          <button id="closeModalBtn" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold transition">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Referencias UI ---
    const addBtn = document.getElementById('addBtn');
    const clearBtn = document.getElementById('clearBtn');
    const playAllBtn = document.getElementById('playAllBtn');
    const youtubeLink = document.getElementById('youtubeLink');
    const songList = document.getElementById('songList');
    const songCount = document.getElementById('songCount');
    const emptyState = document.getElementById('emptyState');
    const songListHeader = document.getElementById('songListHeader');

    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalUrl = document.getElementById('modalUrl');
    const openYouTube = document.getElementById('openYouTube');
    const closeModal = document.getElementById('closeModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    // --- Estado ---
    let songs = [];
    let draggedIndex = null;
    let currentIndex = -1;

    // YT Player
    let ytPlayer = null;
    let firstPlayMuted = true; // primera reproducciÃ³n muteada para evitar bloqueos

    // La API llama a esta funciÃ³n global cuando estÃ¡ lista
    window.onYouTubeIframeAPIReady = function () {
      ytPlayer = new YT.Player('modalPlayer', {
        host: 'https://www.youtube-nocookie.com',
        playerVars: {
          rel: 0,
          modestbranding: 1,
          playsinline: 1,
          autoplay: 1, // respetado si hubo interacciÃ³n (abrir modal)
        },
        events: {
          onReady: (e) => {
            // Nada por ahora; cargamos los videos vÃ­a playIndex
          },
          onStateChange: (e) => {
            // Avanzar cuando termine el video actual
            if (e.data === YT.PlayerState.ENDED) {
              nextVideo();
            }
          }
        }
      });
    };

    // --- Utilidades YouTube ---
    function extractVideoId(url) {
      try {
        const u = new URL(url);
        if (u.hostname.includes('youtu.be')) return u.pathname.slice(1).split('/')[0];
        if (u.pathname.startsWith('/shorts/')) return u.pathname.split('/')[2];
        if (u.searchParams.get('v')) return u.searchParams.get('v');
      } catch {}
      const m = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})(?:[?&/]|$)/);
      return m ? m[1] : null;
    }

    function buildWatchUrl(videoId) {
      return `https://www.youtube.com/watch?v=${videoId}`;
    }

    function buildPlaylistUrl() {
      if (songs.length === 0) return null;
      return `https://www.youtube.com/watch_videos?video_ids=${songs.map(s => s.id).join(',')}`;
    }

    // --- Lista ---
    function addSongFromUrl(url) {
      const id = extractVideoId(url);
      if (!id) return alert('âš ï¸ Enlace de YouTube no vÃ¡lido. AsegÃºrate de pegar un enlace completo.');
      if (songs.find(s => s.id === id)) return alert('â„¹ï¸ Esta canciÃ³n ya estÃ¡ en tu lista.');

      songs.push({ id, createdAt: Date.now() });
      renderList();
      youtubeLink.value = '';
      youtubeLink.focus();
    }

    function removeSong(index) {
      songs.splice(index, 1);
      // Ajustar currentIndex si corresponde
      if (currentIndex >= songs.length) currentIndex = songs.length - 1;
      renderList();
    }

    function moveSong(fromIndex, toIndex) {
      const [movedSong] = songs.splice(fromIndex, 1);
      songs.splice(toIndex, 0, movedSong);
      if (currentIndex === fromIndex) currentIndex = toIndex;
      renderList();
    }

    function moveUp(index) { if (index > 0) moveSong(index, index - 1); }
    function moveDown(index) { if (index < songs.length - 1) moveSong(index, index + 1); }

    // --- Modal / ReproducciÃ³n ---
    function openModalByIndex(index) {
      if (index < 0 || index >= songs.length) return;
      currentIndex = index;

      const id = songs[currentIndex].id;
      const watchUrl = buildWatchUrl(id);

      modalTitle.textContent = `Video #${currentIndex + 1}`;
      modalUrl.textContent = watchUrl;
      openYouTube.href = watchUrl;

      modal.classList.remove('hidden');
      modal.classList.add('flex');

      // Cargar y reproducir con IFrame API
      playIndex(currentIndex);
    }

    function closeModalFn() {
      if (ytPlayer) {
        try { ytPlayer.stopVideo(); } catch {}
      }
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function playIndex(index) {
      if (!ytPlayer || index < 0 || index >= songs.length) return;
      const id = songs[index].id;

      // Carga y reproduce
      ytPlayer.loadVideoById({ videoId: id });

      // Primera reproducciÃ³n muteada para evitar bloqueos; luego desmutea
      if (firstPlayMuted) {
        ytPlayer.mute();
        // Intenta desmutear pasados unos ms (ya hubo interacciÃ³n del usuario)
        setTimeout(() => { try { ytPlayer.unMute(); } catch {} }, 600);
        firstPlayMuted = false;
      }
    }

    function nextVideo() {
      if (currentIndex < songs.length - 1) {
        currentIndex += 1;
        playIndex(currentIndex);
        updateModalHeader();
      } else {
        // Fin de lista
        closeModalFn();
      }
    }

    function prevVideo() {
      if (currentIndex > 0) {
        currentIndex -= 1;
        playIndex(currentIndex);
        updateModalHeader();
      }
    }

    function updateModalHeader() {
      if (currentIndex >= 0) {
        const id = songs[currentIndex].id;
        modalTitle.textContent = `Video #${currentIndex + 1}`;
        modalUrl.textContent = buildWatchUrl(id);
        openYouTube.href = buildWatchUrl(id);
      }
    }

    // --- Pintado de la lista ---
    function renderList() {
      songList.innerHTML = '';
      songCount.textContent = `(${songs.length})`;

      if (songs.length === 0) {
        emptyState.classList.remove('hidden');
        songListHeader.classList.add('hidden');
        return;
      }
      emptyState.classList.add('hidden');
      songListHeader.classList.remove('hidden');

      songs.forEach((s, index) => {
        const thumb = `https://img.youtube.com/vi/${s.id}/hqdefault.jpg`;
        const watchUrl = buildWatchUrl(s.id);

        const li = document.createElement('li');
        li.className = 'bg-gray-800 rounded-xl overflow-hidden hover:ring-2 hover:ring-purple-500 transition shadow-lg';
        li.draggable = true;
        li.dataset.index = index;

        li.innerHTML = `
          <button class="w-full text-left flex flex-col group">
            <div class="relative">
              <img src="${thumb}" alt="thumbnail" class="w-full h-40 object-cover">
              <div class="absolute inset-0 bg-black/0 group-hover:bg-black/50 transition flex items-center justify-center">
                <span class="text-6xl opacity-0 group-hover:opacity-100 transition">â–¶ï¸</span>
              </div>
              <div class="absolute top-2 left-2 bg-purple-600 text-white px-3 py-1 rounded-full font-bold text-sm">
                #${index + 1}
              </div>
            </div>
            <div class="p-4">
              <div class="font-bold text-lg mb-1 flex items-center gap-2">
                <span>ğŸµ CanciÃ³n ${index + 1}</span>
                <span class="text-gray-400 text-sm">ğŸ”„ Arrastra para mover</span>
              </div>
              <div class="text-sm text-gray-400 truncate">${s.id}</div>
            </div>
          </button>
          <div class="flex gap-2 p-4 pt-0">
            <button class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded-lg transition moveUpBtn ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === 0 ? 'disabled' : ''} title="Mover arriba">â¬†ï¸</button>
            <button class="bg-gray-600 hover:bg-gray-500 px-3 py-2 rounded-lg transition moveDownBtn ${index === songs.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === songs.length - 1 ? 'disabled' : ''} title="Mover abajo">â¬‡ï¸</button>
            <a href="${watchUrl}" target="_blank" class="flex-1 bg-red-600 hover:bg-red-700 py-2 rounded-lg text-center font-semibold transition">ğŸ¬ YouTube</a>
            <button class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-semibold transition playModalBtn">â–¶ï¸</button>
            <button class="bg-gray-600 hover:bg-red-600 px-4 py-2 rounded-lg transition removeBtn" title="Eliminar">ğŸ—‘ï¸</button>
          </div>
        `;

        // Clicks
        li.querySelector('button').addEventListener('click', () => openModalByIndex(index));
        li.querySelector('.playModalBtn').addEventListener('click', (e) => { e.stopPropagation(); openModalByIndex(index); });
        li.querySelector('.removeBtn').addEventListener('click', (e) => { e.stopPropagation(); removeSong(index); });
        li.querySelector('.moveUpBtn').addEventListener('click', (e) => { e.stopPropagation(); moveUp(index); });
        li.querySelector('.moveDownBtn').addEventListener('click', (e) => { e.stopPropagation(); moveDown(index); });

        // Drag & drop
        li.addEventListener('dragstart', () => { draggedIndex = index; li.classList.add('dragging'); });
        li.addEventListener('dragend', () => { li.classList.remove('dragging'); draggedIndex = null; });
        li.addEventListener('dragover', (e) => { e.preventDefault(); li.classList.add('drag-over'); });
        li.addEventListener('dragleave', () => { li.classList.remove('drag-over'); });
        li.addEventListener('drop', (e) => {
          e.preventDefault();
          li.classList.remove('drag-over');
          if (draggedIndex !== null && draggedIndex !== index) moveSong(draggedIndex, index);
        });

        songList.appendChild(li);
      });
    }

    // --- Eventos generales ---
    addBtn.addEventListener('click', () => {
      const link = youtubeLink.value.trim();
      if (link) addSongFromUrl(link);
    });

    youtubeLink.addEventListener('keydown', (e) => { if (e.key === 'Enter') addBtn.click(); });

    clearBtn.addEventListener('click', () => {
      if (songs.length === 0) return;
      if (confirm('ğŸ—‘ï¸ Â¿Eliminar todas las canciones de la lista?')) {
        songs = [];
        currentIndex = -1;
        renderList();
      }
    });

    playAllBtn.addEventListener('click', () => {
      if (songs.length === 0) return;
      openModalByIndex(0); // abre modal y empieza desde la primera
    });

    // Controles del modal
    document.getElementById('closeModal').addEventListener('click', closeModalFn);
    document.getElementById('closeModalBtn').addEventListener('click', closeModalFn);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModalFn(); });

    prevBtn.addEventListener('click', (e) => { e.stopPropagation(); prevVideo(); });
    nextBtn.addEventListener('click', (e) => { e.stopPropagation(); nextVideo(); });

    // Inicializar
    renderList();
    youtubeLink.focus();
  </script>
</body>
</html>
